<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Notes</title>
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<style>
body { font-family: serif; margin: 20px; }
.app { max-width: 700px; }
header { margin-bottom: 20px; }
.ai-badge { font-size: .75rem; }
.ai-badge.enabled { color: green; }
.ai-badge.disabled { color: gray; }
.note-form { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
.note-form input, .note-form textarea { width: 100%; margin-bottom: 8px; font-family: serif; }
.note-form textarea { height: 80px; }
.btn { cursor: pointer; margin-right: 4px; }
.note-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
.note-card .content { white-space: pre-wrap; margin: 8px 0; }
.note-card .meta { font-size: .8rem; color: gray; }
.note-card .actions { margin-top: 8px; }
.ai-result { margin-top: 8px; border: 1px solid #ccc; padding: 8px; }
.ai-result pre { white-space: pre-wrap; font-family: serif; }
.edit-form input, .edit-form textarea { width: 100%; margin-bottom: 6px; font-family: serif; }
.edit-form textarea { height: 60px; }
.spinner { display: inline-block; }
.spinner::after { content: "Loading..."; }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Smart Notes <span id="ai-badge" class="ai-badge disabled">AI Mock</span></h1>
    <p>Create notes and use AI to summarize, extract tasks, or analyze sentiment</p>
  </header>

  <form class="note-form" id="note-form">
    <input id="note-title" placeholder="Note title…" />
    <textarea id="note-content" placeholder="Write your note here…"></textarea>
    <div class="form-actions">
      <button class="btn" type="submit">Add Note</button>
    </div>
  </form>

  <div id="note-list" class="note-list"></div>
</div>

<script>
const API = '/api';
const noteList = document.getElementById('note-list');
const form = document.getElementById('note-form');
const titleInput = document.getElementById('note-title');
const contentInput = document.getElementById('note-content');
const aiBadge = document.getElementById('ai-badge');

// Check AI status
fetch(`${API}/health`).then(r => r.json()).then(d => {
  if (d.ai_enabled) { aiBadge.className = 'ai-badge enabled'; aiBadge.textContent = 'AI ON'; }
}).catch(() => {});

// Load notes
async function loadNotes() {
  try {
    const res = await fetch(`${API}/notes`);
    const notes = await res.json();
    if (notes.length === 0) {
      noteList.innerHTML = '<p>No notes yet. Create one above!</p>';
      return;
    }
    noteList.innerHTML = notes.map(n => noteCard(n)).join('');
  } catch (e) {
    noteList.innerHTML = '<div class="empty-state"><p>Failed to load notes.</p></div>';
  }
}

function noteCard(n) {
  const date = new Date(n.created_at).toLocaleString();
  return `<div class="note-card" id="note-${n.id}">
    <div class="note-card-header">
      <h3>${esc(n.title)}</h3>
      <div class="header-btns">
        <button class="btn" onclick="startEdit('${n.id}')">Edit</button>
        <button class="btn" onclick="delNote('${n.id}')">Delete</button>
      </div>
    </div>
    <div class="meta">${date}</div>
    <div class="content">${esc(n.content)}</div>
    <div class="actions">
      <button class="btn" onclick="aiAction('${n.id}','summarize',this)">Summarize</button>
      <button class="btn" onclick="aiAction('${n.id}','action_items',this)">Action Items</button>
      <button class="btn" onclick="aiAction('${n.id}','sentiment',this)">Sentiment</button>
    </div>
    <div id="ai-${n.id}"></div>
  </div>`;
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// Create note
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = titleInput.value.trim();
  const content = contentInput.value.trim();
  if (!title || !content) return;
  await fetch(`${API}/notes`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title, content })
  });
  titleInput.value = ''; contentInput.value = '';
  loadNotes();
});

// Delete note
async function delNote(id) {
  await fetch(`${API}/notes/${id}`, { method: 'DELETE' });
  loadNotes();
}

// Edit note
async function startEdit(id) {
  const res = await fetch(`${API}/notes/${id}`);
  const n = await res.json();
  const card = document.getElementById(`note-${id}`);
  card.innerHTML = `<div class="edit-form">
    <input id="edit-title-${id}" value="${esc(n.title)}" />
    <textarea id="edit-content-${id}">${esc(n.content)}</textarea>
    <div class="edit-actions">
      <button class="btn" onclick="saveEdit('${id}')">Save</button>
      <button class="btn" onclick="loadNotes()">Cancel</button>
    </div>
  </div>`;
}

async function saveEdit(id) {
  const title = document.getElementById(`edit-title-${id}`).value.trim();
  const content = document.getElementById(`edit-content-${id}`).value.trim();
  if (!title || !content) return;
  await fetch(`${API}/notes/${id}`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title, content })
  });
  loadNotes();
}

// AI action
async function aiAction(id, action, btn) {
  const container = document.getElementById(`ai-${id}`);
  container.innerHTML = '<span class="spinner"></span>';
  const btns = btn.parentElement.querySelectorAll('button');
  btns.forEach(b => b.disabled = true);
  try {
    const res = await fetch(`${API}/notes/${id}/ai/${action}`, { method: 'POST' });
    const data = await res.json();
    container.innerHTML = `<div class="ai-result"><h4>${data.action.replace('_', ' ')}</h4><pre>${esc(data.result)}</pre></div>`;
  } catch (e) {
    container.innerHTML = `<div class="ai-result"><h4>Error</h4><pre>${e.message}</pre></div>`;
  }
  btns.forEach(b => b.disabled = false);
}

loadNotes();
</script>
</body>
</html>
